import{Node}from"./node.js";class Flow{canvasStartX=0;canvasStartY=0;canvasTranslateX=0;canvasTranslateY=0;canvas=null;canvasEl=null;lastScale=1;lastZoomDirection=null;zoomTollerance={min:1,max:5};zoomScale=.05;isDragging=!1;maxTranslateXAllowed=0;maxTranslateYAllowed=0;ctx=null;nodes=[];isNodeDragging=!1;strokeColor="white";strokeWidth=1;element=null;constructor(){this.element=document.querySelector(".fp-flow-container"),this.canvas=document.createElement("div"),this.canvas.id="fp-flow-canvas",this.canvas.classList.add("fp-flow-container-inner"),this.element.appendChild(this.canvas),this.canvasEl=document.createElement("canvas"),this.canvasEl.id="lineCanvas",this.canvasEl.classList.add("line-canvas"),this.canvas.appendChild(this.canvasEl),this.canvasEl.width=this.canvas.offsetWidth,this.canvasEl.height=this.canvas.offsetHeight,this.ctx=this.canvasEl.getContext("2d"),this.init(),window.addEventListener("resize",()=>{this.canvasEl.width=this.canvas.offsetWidth,this.canvasEl.height=this.canvas.offsetHeight,this.refreshCanvas()})}drawLine(t,s,e,a){this.ctx.beginPath(),this.ctx.moveTo(t,s),this.ctx.lineTo(e,a),this.ctx.strokeStyle=this.strokeColor,this.ctx.lineWidth=this.strokeWidth/this.lastScale,this.ctx.stroke()}refreshCanvas(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);const n=[];this.nodes.forEach(i=>{i.connectedNodes.forEach(s=>{var t=i,e=this.nodes.find(t=>t.id===s),a=t.id>e.id?e.id+"-"+t.id:t.id+"-"+e.id;n.includes(a)||(this.drawLine(t.centerX,t.centerY,e.centerX,e.centerY),n.push(a))})})}addNode(t){var s=Math.max(...this.nodes.map(t=>t.id),-1)+1,s=new Node(t,s),e=(this.canvas.appendChild(t),s.containerElement=this.element,this.canvasTranslateX+this.element.offsetWidth/2-t.offsetWidth/2),a=this.canvasTranslateY+this.element.offsetHeight/2-t.offsetHeight/2;return t.style.transform=`scale(${1/this.lastScale})`,t.style.left=e+"px",t.style.top=a+"px",this.nodes.push(s),s.onNodeMoveStart(t=>{this.isNodeDragging=!0}),s.onNodeMove((t,s)=>{this.refreshCanvas()}),s.onNodeMoveEnd(t=>{this.isNodeDragging=!1}),s}removeNode(s){this.nodes.find(t=>t.id===s).element.remove(),this.nodes=this.nodes.filter(t=>t.id!==s),this.nodes.forEach(t=>{t.connectedNodes=t.connectedNodes.filter(t=>t!==s)}),this.refreshCanvas()}addConnection(s,e){s=parseInt(s),e=parseInt(e);var t=this.nodes.find(t=>t.id===s),a=this.nodes.find(t=>t.id===e);t.connectedNodes.includes(e)||a.connectedNodes.includes(s)||(t.connectedNodes.push(e),a.connectedNodes.push(s)),this.refreshCanvas()}removeConnection(s,e){s=parseInt(s),e=parseInt(e);var t=this.nodes.find(t=>t.id===s),a=this.nodes.find(t=>t.id===e);t.connectedNodes=t.connectedNodes.filter(t=>t!==e),a.connectedNodes=a.connectedNodes.filter(t=>t!==s),this.refreshCanvas()}init(){this.canvas.addEventListener("mousedown",t=>{this.isNodeDragging||(this.canvas.style.cursor="grabbing",this.canvasStartX=t.clientX,this.canvasStartY=t.clientY,this.isDragging=!0)}),this.canvas.addEventListener("mousemove",t=>{var s,e,a;t.preventDefault(),this.isDragging&&!this.isNodeDragging&&(s=t.clientX,t=t.clientY,e=s-this.canvasStartX,a=t-this.canvasStartY,this.canvasTranslateX+=e,this.canvasTranslateY+=a,this.canvasStartX=s,this.canvasStartY=t,this.canvasTranslateX>this.maxTranslateXAllowed&&(this.canvasTranslateX=this.maxTranslateXAllowed),this.canvasTranslateX<-this.maxTranslateXAllowed&&(this.canvasTranslateX=-this.maxTranslateXAllowed),this.canvasTranslateY>this.maxTranslateYAllowed&&(this.canvasTranslateY=this.maxTranslateYAllowed),this.canvasTranslateY<-this.maxTranslateYAllowed&&(this.canvasTranslateY=-this.maxTranslateYAllowed),this.canvas.style.transform=`translate(${this.canvasTranslateX}px, ${this.canvasTranslateY}px) scale(${this.lastScale})`)}),this.canvas.addEventListener("mouseup",t=>{this.canvas.style.cursor="initial",this.isDragging=!1}),this.canvas.addEventListener("wheel",t=>{t.preventDefault(),t.stopPropagation(),t.ctrlKey&&(t=0<t.wheelDelta/120?"zoomout":"zoomin","zoomout"===this.lastZoomDirection&&"zoomout"==t&&this.lastScale>=this.zoomTollerance.max||"zoomin"===this.lastZoomDirection&&"zoomin"==t&&this.lastScale<=this.zoomTollerance.min||(this.lastScale+="zoomout"==t?this.zoomScale:-1*this.zoomScale,this.lastZoomDirection=t,this.lastScale<1&&(this.lastScale=1),this.maxTranslateXAllowed=(this.canvas.offsetWidth*this.lastScale-this.canvas.offsetWidth)/2,this.maxTranslateYAllowed=(this.canvas.offsetHeight*this.lastScale-this.canvas.offsetHeight)/2,this.nodes.forEach(t=>{t.element.style.transform=`scale(${1/this.lastScale})`,t.canvasScale=this.lastScale,t.setCenter()}),this.canvas.style.transform=`scale(${this.lastScale})`,this.refreshCanvas()))})}getRenditionInfo(){const s={};["nodes","canvasTranslateX","canvasTranslateY","lastScale","canvasStartX","canvasStartY","strokeColor","strokeWidth"].forEach(t=>{s[t]=this[t]}),s.requiredWidth=this.canvas.offsetWidth,s.requiredHeight=this.canvas.offsetHeight;const t=["startX","startY","data","id","connectedNodes"];return s.nodes=s.nodes.map(s=>{s.setCenter();const e={};return t.forEach(t=>{e[t]=s[t]}),e}),s}renderSavedFlow(t){for(const i in t)"nodes"!==i&&"requiredWidth"!==i&&"requiredHeight"!==i&&(this[i]=t[i]);let s=this.lastScale,e=this.lastScale;var a;this.canvasEl.width<t.requiredWidth&&(this.canvasEl.width=t.requiredWidth,a=t.requiredWidth/this.canvasEl.offsetWidth,s=this.lastScale*a),this.canvasEl.height<t.requiredHeight&&(this.canvasEl.height=t.requiredHeight,a=t.requiredHeight/this.canvasEl.offsetHeight,e=this.lastScale*a),this.canvas.style.transform=`translate(${this.canvasTranslateX}px, ${this.canvasTranslateY}px) scale(${s}, ${e})`,t.nodes.forEach(t=>{var s=t.element||document.createElement("div"),e=this.addNode(s);for(const a in t)e[a]=t[a];s.style.left=t.startX*this.lastScale+"px",s.style.top=t.startY*this.lastScale+"px",t.element||(s.innerText="Node "+t.id)}),setTimeout(()=>{this.refreshCanvas()})}refreshFlow(){setTimeout(()=>{this.nodes.forEach(t=>{t.setCenter()}),this.refreshCanvas()})}}window.Flow=Flow;export{Flow};