import{Node}from"./node.js";class FPFlow{canvasStartX=0;canvasStartY=0;canvasNewX=0;canvasNewY=0;canvasTranslateX=0;canvasTranslateY=0;canvas=null;canvasEl=null;lastScale=1;lastZoomDirection=null;zoomTollerance={min:1,max:3};zoomScale=.05;isDragging=!1;maxTranslateXAllowed=0;maxTranslateYAllowed=0;ctx=null;nodes=[];isNodeDragging=!1;constructor(){var s=document.querySelector(".fp-scroll-container");this.canvas=document.createElement("div"),this.canvas.id="canvas",this.canvas.classList.add("flow-container"),s.appendChild(this.canvas),this.canvasEl=document.createElement("canvas"),this.canvasEl.id="lineCanvas",this.canvasEl.classList.add("line-canvas"),this.canvas.appendChild(this.canvasEl),this.canvasEl.width=canvas.offsetWidth,this.canvasEl.height=canvas.offsetHeight,this.ctx=this.canvasEl.getContext("2d"),this.init()}drawLine(s,a,t,e){this.ctx.beginPath(),this.ctx.moveTo(s,a),this.ctx.lineTo(t,e),this.ctx.strokeStyle="white",this.ctx.lineWidth=1/this.lastScale,this.ctx.stroke()}refreshCanvas(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);const i=[];this.nodes.forEach(n=>{n.connectedNodes.forEach(a=>{var s=n,t=this.nodes.find(s=>s.id===a),e=s.id>t.id?t.id+"-"+s.id:s.id+"-"+t.id;i.includes(e)||(this.drawLine(s.centerX,s.centerY,t.centerX,t.centerY),i.push(e))})})}addNode(s){var a=this.nodes.length,a=new Node(s,a);return this.canvas.appendChild(s),s.style.transform=`scale(${1/this.lastScale})`,this.nodes.push(a),a.onNodeMoveStart(s=>{this.isNodeDragging=!0}),a.onNodeMove((s,a)=>{this.refreshCanvas()}),a.onNodeMoveEnd(s=>{this.isNodeDragging=!1}),a}removeNode(a){this.nodes.find(s=>s.id===a).element.remove(),this.nodes=this.nodes.filter(s=>s.id!==a),this.nodes.forEach(s=>{s.connectedNodes=s.connectedNodes.filter(s=>s!==a)}),this.refreshCanvas()}addConnection(a,t){a=parseInt(a),t=parseInt(t);var s=this.nodes.find(s=>s.id===a),e=this.nodes.find(s=>s.id===t);s.connectedNodes.includes(t)||e.connectedNodes.includes(a)||(s.connectedNodes.push(t),e.connectedNodes.push(a)),this.refreshCanvas()}removeConnection(a,t){a=parseInt(a),t=parseInt(t);var s=this.nodes.find(s=>s.id===a),e=this.nodes.find(s=>s.id===t);s.connectedNodes=s.connectedNodes.filter(s=>s!==t),e.connectedNodes=e.connectedNodes.filter(s=>s!==a),this.refreshCanvas()}init(){this.canvas.addEventListener("mousedown",s=>{this.isNodeDragging||(this.canvas.style.cursor="grabbing",this.canvasStartX=s.clientX,this.canvasStartY=s.clientY,this.isDragging=!0)}),this.canvas.addEventListener("mousemove",s=>{var a;s.preventDefault(),this.isDragging&&!this.isNodeDragging&&(this.canvasNewX=s.clientX,this.canvasNewY=s.clientY,s=this.canvasNewX-this.canvasStartX,a=this.canvasNewY-this.canvasStartY,this.canvasTranslateX+=s,this.canvasTranslateY+=a,this.canvasStartX=this.canvasNewX,this.canvasStartY=this.canvasNewY,this.canvasTranslateX>this.maxTranslateXAllowed&&(this.canvasTranslateX=this.maxTranslateXAllowed),this.canvasTranslateX<-this.maxTranslateXAllowed&&(this.canvasTranslateX=-this.maxTranslateXAllowed),this.canvasTranslateY>this.maxTranslateYAllowed&&(this.canvasTranslateY=this.maxTranslateYAllowed),this.canvasTranslateY<-this.maxTranslateYAllowed&&(this.canvasTranslateY=-this.maxTranslateYAllowed),this.canvas.style.transform=`translate(${this.canvasTranslateX}px, ${this.canvasTranslateY}px) scale(${this.lastScale})`)}),this.canvas.addEventListener("mouseup",s=>{this.canvas.style.cursor="initial",this.isDragging=!1}),this.canvas.addEventListener("wheel",s=>{s.preventDefault(),s.ctrlKey&&(s=0<s.wheelDelta/120?"zoomout":"zoomin","zoomout"===this.lastZoomDirection&&"zoomout"==s&&this.lastScale>=this.zoomTollerance.max||"zoomin"===this.lastZoomDirection&&"zoomin"==s&&this.lastScale<=this.zoomTollerance.min||(this.lastScale+="zoomout"==s?this.zoomScale:-1*this.zoomScale,this.lastZoomDirection=s,this.maxTranslateXAllowed=(this.canvas.offsetWidth*this.lastScale-this.canvas.offsetWidth)/2,this.maxTranslateYAllowed=(this.canvas.offsetHeight*this.lastScale-this.canvas.offsetHeight)/2,this.lastScale<1&&(this.lastScale=1),this.nodes.forEach(s=>{s.element.style.transform=`scale(${1/this.lastScale})`,s.canvasScale=this.lastScale,s.setCenter()}),this.canvas.style.transform=`scale(${this.lastScale})`,this.refreshCanvas()))})}}window.FPFlow=FPFlow;export{FPFlow};